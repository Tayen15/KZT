<!-- Channel Dropdown Component -->
<!-- Usage: <%- include('../components/channel-dropdown', { channels, selectedChannelId: settings.channelId || '', fieldName: 'channelId' }) %> -->

<select 
    id="channelSelect" 
    name="<%= fieldName || 'channelId' %>" 
    required 
    class="w-full bg-[#23272f] border border-[#3a3f4b] rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-[#5865F2] focus:ring-2 focus:ring-[#5865F2]/20 transition-all"
>
    <option value="">Loading channels...</option>
</select>

<script>
    (function() {
        const channelsData = JSON.parse('<%- JSON.stringify(channels) %>');
        const selectedChannelId = '<%= selectedChannelId || "" %>';

        function loadChannelDropdown() {
            const select = document.getElementById('channelSelect');
            if (!select) return;

            select.innerHTML = '<option value="">Select a text channel...</option>';
            
            // Group by category if available
            const categories = {};
            channelsData.forEach(ch => {
                const category = ch.category || 'Uncategorized';
                if (!categories[category]) categories[category] = [];
                categories[category].push(ch);
            });

            // Render channels
            Object.keys(categories).forEach(category => {
                if (Object.keys(categories).length > 1) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = category;
                    
                    categories[category].forEach(ch => {
                        const opt = document.createElement('option');
                        opt.value = ch.id;
                        opt.textContent = '# ' + ch.name;
                        if (selectedChannelId === ch.id) opt.selected = true;
                        optgroup.appendChild(opt);
                    });
                    
                    select.appendChild(optgroup);
                } else {
                    // No categories, flat list
                    categories[category].forEach(ch => {
                        const opt = document.createElement('option');
                        opt.value = ch.id;
                        opt.textContent = '# ' + ch.name;
                        if (selectedChannelId === ch.id) opt.selected = true;
                        select.appendChild(opt);
                    });
                }
            });
        }

        // Load on DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadChannelDropdown);
        } else {
            loadChannelDropdown();
        }
    })();
</script>
